<!--DOIæ–‡çŒ®æŸ¥è¯¢é¡µé¢-->
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">ğŸ“– DOIæ–‡çŒ®æŸ¥è¯¢</text>
    <text class="page-desc">è¾“å…¥DOIè·å–æ–‡çŒ®ä¿¡æ¯å’Œå¼•ç”¨æ ¼å¼</text>
  </view>

  <!-- è‡ªåŠ¨æŸ¥è¯¢æ¨¡å¼ -->
  <view class="query-section" wx:if="{{!manualMode}}">
    <!-- DOIè¾“å…¥æ¡† -->
    <view class="input-group">
      <text class="input-label">DOIæ ‡è¯†ç¬¦</text>
      <view class="input-wrapper">
        <input 
          class="doi-input" 
          type="text" 
          placeholder="ä¾‹ï¼š10.1038/nature12345"
          value="{{doiInput}}"
          bindinput="handleDOIInput"
          confirm-type="search"
          bindconfirm="queryDOI"
        />
        <button class="scan-btn" size="mini" bindtap="scanDOI">æ‰«ç </button>
      </view>
      <text class="input-hint">æ”¯æŒæ‰«æDOIäºŒç»´ç æˆ–æ¡å½¢ç </text>
    </view>

    <!-- æŸ¥è¯¢æŒ‰é’® -->
    <button 
      class="query-btn" 
      type="primary" 
      bindtap="queryDOI"
      loading="{{isQuerying}}"
      disabled="{{isQuerying}}"
    >
      {{isQuerying ? 'æŸ¥è¯¢ä¸­...' : 'æŸ¥è¯¢æ–‡çŒ®'}}
    </button>

    <!-- æ‰‹åŠ¨è¾“å…¥åˆ‡æ¢ -->
    <view class="mode-switch">
      <text class="switch-text" bindtap="switchToManualMode">ç½‘ç»œå¼‚å¸¸ï¼Ÿåˆ‡æ¢åˆ°æ‰‹åŠ¨è¾“å…¥ â†’</text>
    </view>
  </view>

  <!-- æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ -->
  <view class="manual-section" wx:if="{{manualMode}}">
    <view class="mode-header">
      <text class="mode-title">æ‰‹åŠ¨è¾“å…¥æ¨¡å¼</text>
      <text class="mode-link" bindtap="switchToAutoMode">â† è¿”å›è‡ªåŠ¨æŸ¥è¯¢</text>
    </view>

    <view class="manual-form">
      <view class="form-item">
        <text class="form-label">æ ‡é¢˜ *</text>
        <input 
          class="form-input" 
          type="text" 
          placeholder="æ–‡çŒ®æ ‡é¢˜"
          value="{{manualData.title}}"
          data-field="title"
          bindinput="handleManualInput"
        />
      </view>

      <view class="form-item">
        <text class="form-label">ä½œè€… *</text>
        <input 
          class="form-input" 
          type="text" 
          placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šJohn Doe, Jane Smith"
          value="{{manualData.authors}}"
          data-field="authors"
          bindinput="handleManualInput"
        />
      </view>

      <view class="form-item">
        <text class="form-label">æœŸåˆŠ *</text>
        <input 
          class="form-input" 
          type="text" 
          placeholder="æœŸåˆŠåç§°"
          value="{{manualData.journal}}"
          data-field="journal"
          bindinput="handleManualInput"
        />
      </view>

      <view class="form-row">
        <view class="form-item-half">
          <text class="form-label">å¹´ä»½ *</text>
          <input 
            class="form-input" 
            type="number" 
            placeholder="2023"
            value="{{manualData.year}}"
            data-field="year"
            bindinput="handleManualInput"
          />
        </view>
        <view class="form-item-half">
          <text class="form-label">å·å·</text>
          <input 
            class="form-input" 
            type="text" 
            placeholder="123"
            value="{{manualData.volume}}"
            data-field="volume"
            bindinput="handleManualInput"
          />
        </view>
      </view>

      <view class="form-row">
        <view class="form-item-half">
          <text class="form-label">æœŸå·</text>
          <input 
            class="form-input" 
            type="text" 
            placeholder="4"
            value="{{manualData.issue}}"
            data-field="issue"
            bindinput="handleManualInput"
          />
        </view>
        <view class="form-item-half">
          <text class="form-label">é¡µç </text>
          <input 
            class="form-input" 
            type="text" 
            placeholder="123-456"
            value="{{manualData.pages}}"
            data-field="pages"
            bindinput="handleManualInput"
          />
        </view>
      </view>

      <view class="form-item">
        <text class="form-label">DOIï¼ˆå¯é€‰ï¼‰</text>
        <input 
          class="form-input" 
          type="text" 
          placeholder="10.1038/nature12345"
          value="{{manualData.doi}}"
          data-field="doi"
          bindinput="handleManualInput"
        />
      </view>

      <button class="query-btn" type="primary" bindtap="generateFromManual">
        ç”Ÿæˆå¼•ç”¨
      </button>
    </view>
  </view>

  <!-- æ–‡çŒ®ä¿¡æ¯å±•ç¤º -->
  <view class="metadata-section" wx:if="{{showMetadata && metadata}}">
    <view class="section-header">
      <text class="section-title">ğŸ“„ æ–‡çŒ®ä¿¡æ¯</text>
    </view>

    <view class="metadata-card">
      <!-- æ ‡é¢˜ -->
      <view class="meta-item title-item">
        <text class="meta-value">{{metadata.title}}</text>
      </view>

      <!-- ä½œè€… -->
      <view class="meta-item" wx:if="{{metadata.authors && metadata.authors.length > 0}}">
        <text class="meta-label">ä½œè€…ï¼š</text>
        <text class="meta-value">
          <block wx:for="{{metadata.authors}}" wx:key="index">
            {{item.given}} {{item.family}}{{index < metadata.authors.length - 1 ? ', ' : ''}}
          </block>
        </text>
      </view>

      <!-- æœŸåˆŠ -->
      <view class="meta-item" wx:if="{{metadata.journal}}">
        <text class="meta-label">æœŸåˆŠï¼š</text>
        <text class="meta-value">{{metadata.journal}}</text>
      </view>

      <!-- å¹´å·æœŸé¡µ -->
      <view class="meta-item">
        <text class="meta-label">å‡ºç‰ˆï¼š</text>
        <text class="meta-value">
          {{metadata.year || 'N/A'}}{{metadata.volume ? ', ' + metadata.volume : ''}}{{metadata.issue ? '(' + metadata.issue + ')' : ''}}{{metadata.pages ? ': ' + metadata.pages : ''}}
        </text>
      </view>

      <!-- DOI -->
      <view class="meta-item" wx:if="{{metadata.doi}}">
        <text class="meta-label">DOIï¼š</text>
        <text class="meta-value doi-link" bindtap="openDOILink">{{metadata.doi}}</text>
      </view>
    </view>
  </view>

  <!-- å¼•ç”¨æ ¼å¼ -->
  <view class="citation-section" wx:if="{{showMetadata && metadata}}">
    <view class="section-header">
      <text class="section-title">ğŸ“‹ å¼•ç”¨æ ¼å¼</text>
    </view>

    <!-- æ ¼å¼é€‰æ‹© -->
    <scroll-view class="format-tabs" scroll-x>
      <view class="format-tabs-inner">
        <view 
          class="format-tab {{currentFormat === item.id ? 'active' : ''}}"
          wx:for="{{formats}}"
          wx:key="id"
          data-format="{{item.id}}"
          data-name="{{item.name}}"
          bindtap="switchFormat"
        >
          <text class="format-name">{{item.name}}</text>
          <text class="format-desc">{{item.description}}</text>
        </view>
      </view>
    </scroll-view>

    <!-- å¼•ç”¨å†…å®¹ -->
    <view class="citation-card">
      <text class="citation-text" selectable>{{citation}}</text>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="action-btn copy-btn" bindtap="copyCitation">
        ğŸ“‹ å¤åˆ¶å¼•ç”¨
      </button>
      <button class="action-btn share-btn" bindtap="shareCitation">
        ğŸ“¤ åˆ†äº«å¼•ç”¨
      </button>
    </view>
  </view>

  <!-- å†å²è®°å½• -->
  <view class="history-section">
    <view class="section-header" bindtap="toggleHistory">
      <text class="section-title">ğŸ• æŸ¥è¯¢å†å² ({{history.length}})</text>
      <text class="toggle-icon">{{showHistory ? 'â–¼' : 'â–¶'}}</text>
    </view>

    <view class="history-list" wx:if="{{showHistory}}">
      <view 
        class="history-item"
        wx:for="{{history}}"
        wx:key="doi"
        data-doi="{{item.doi}}"
        bindtap="selectFromHistory"
      >
        <view class="history-title">{{item.title}}</view>
        <view class="history-meta">
          <text class="history-journal">{{item.journal}}</text>
          <text class="history-year">{{item.year}}</text>
        </view>
        <view class="history-doi">DOI: {{item.doi}}</view>
      </view>

      <view class="history-empty" wx:if="{{history.length === 0}}">
        <text>æš‚æ— æŸ¥è¯¢å†å²</text>
      </view>

      <button class="clear-history-btn" size="mini" bindtap="clearHistory" wx:if="{{history.length > 0}}">
        æ¸…é™¤å†å²
      </button>
    </view>
  </view>

  <!-- ç¼“å­˜ç»Ÿè®¡ -->
  <view class="cache-stats" wx:if="{{cacheStats}}">
    <text class="stats-text">ç¼“å­˜ï¼š{{cacheStats.size}}/{{cacheStats.maxSize}} æ¡ï¼ˆæœ‰æ•ˆæœŸ {{cacheStats.expiryHours}} å°æ—¶ï¼‰</text>
  </view>

  <!-- ä½¿ç”¨è¯´æ˜ -->
  <view class="help-section">
    <text class="help-title">ğŸ’¡ ä½¿ç”¨è¯´æ˜</text>
    <text class="help-text">1. è¾“å…¥å®Œæ•´DOIï¼ˆå¦‚ï¼š10.1038/nature12345ï¼‰</text>
    <text class="help-text">2. æ”¯æŒæ‰«æDOIäºŒç»´ç å¿«é€Ÿè¾“å…¥</text>
    <text class="help-text">3. ç½‘ç»œå¼‚å¸¸æ—¶å¯åˆ‡æ¢åˆ°æ‰‹åŠ¨è¾“å…¥æ¨¡å¼</text>
    <text class="help-text">4. æ”¯æŒ6ç§å¸¸ç”¨å¼•ç”¨æ ¼å¼è½¬æ¢</text>
    <text class="help-text">5. æŸ¥è¯¢ç»“æœè‡ªåŠ¨ç¼“å­˜ï¼ŒåŠ å¿«é‡å¤æŸ¥è¯¢é€Ÿåº¦</text>
  </view>
</view>

