<wxs module="tools">
  // åˆ¤æ–­æ˜¯å¦å·²æ”¶è—
  function isFavorited(favorites, abbr) {
    for (var i = 0; i < favorites.length; i++) {
      if (favorites[i].abbr === abbr) {
        return true;
      }
    }
    return false;
  }
  
  module.exports = {
    isFavorited: isFavorited
  };
</wxs>

<view class="abbreviation-page">
  <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
  <view class="info-banner">
    <view class="banner-content">
      <text class="banner-icon">ğŸ“š</text>
      <view class="banner-text">
        <text class="banner-title">åŒ–å­¦è¯å“ç¼©å†™æŸ¥è¯¢</text>
        <text class="banner-subtitle">æ”¶å½• {{totalCount}} æ¡å¸¸è§ç¼©å†™</text>
      </view>
      <view class="stats-btn" bindtap="toggleStatistics">
        <text class="stats-icon">{{showStatistics ? 'â–¼' : 'ğŸ“Š'}}</text>
      </view>
    </view>
    
    <!-- æ•°æ®ç»Ÿè®¡é¢æ¿ -->
    <view wx:if="{{showStatistics}}" class="statistics-panel">
      <view class="stat-item">
        <text class="stat-value">{{statistics.totalCount}}</text>
        <text class="stat-label">æ€»æ¡ç›®</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{statistics.categoriesCount}}</text>
        <text class="stat-label">åˆ†ç±»æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{statistics.detailedCount}}</text>
        <text class="stat-label">è¯¦ç»†æ•°æ®</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{statistics.withCAS}}</text>
        <text class="stat-label">CASå·</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{statistics.withFormula}}</text>
        <text class="stat-label">åˆ†å­å¼</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢æ¡† -->
  <view class="search-section">
    <view class="search-box">
      <text class="search-icon">ğŸ”</text>
      <input 
        class="search-input" 
        placeholder="æœç´¢ç¼©å†™ã€å…¨ç§°ã€ä¸­æ–‡å..." 
        value="{{searchQuery}}"
        bindinput="handleSearch"
        bindconfirm="handleSearchConfirm"
      />
      <text wx:if="{{searchQuery}}" class="clear-btn" bindtap="clearSearch">âœ•</text>
    </view>

    <!-- æœç´¢å†å² -->
    <view wx:if="{{!isSearching && searchQuery === '' && searchHistory.length > 0}}" class="search-history">
      <view class="history-header">
        <text class="history-title">æœç´¢å†å²</text>
        <text class="history-clear" bindtap="clearSearchHistory">æ¸…ç©º</text>
      </view>
      <view class="history-tags">
        <view 
          wx:for="{{searchHistory}}" 
          wx:key="*this" 
          class="history-tag"
          bindtap="useHistorySearch"
          data-query="{{item}}"
        >
          {{item}}
        </view>
      </view>
    </view>
  </view>

  <!-- åŠŸèƒ½æŒ‰é’®æ  -->
  <view class="action-bar">
    <view class="action-btn" bindtap="toggleCategoryFilter">
      <text class="action-icon">ğŸ“</text>
      <text class="action-text">{{selectedCategory}}</text>
      <text class="action-arrow">{{showCategoryFilter ? 'â–²' : 'â–¼'}}</text>
    </view>
    <view class="action-btn" bindtap="viewFavorites">
      <text class="action-icon">â­</text>
      <text class="action-text">æ”¶è—({{favorites.length}})</text>
    </view>
  </view>

  <!-- åˆ†ç±»ç­›é€‰é¢æ¿ -->
  <view wx:if="{{showCategoryFilter}}" class="category-panel">
    <view 
      wx:for="{{categories}}" 
      wx:key="*this" 
      class="category-item {{selectedCategory === item ? 'active' : ''}}"
      bindtap="selectCategory"
      data-category="{{item}}"
    >
      <text class="category-name">{{item}}</text>
      <text class="category-count" wx:if="{{item !== 'å…¨éƒ¨' && categoryStats[item]}}">
        ({{categoryStats[item]}})
      </text>
      <text class="category-count" wx:if="{{item === 'å…¨éƒ¨'}}">
        ({{totalCount}})
      </text>
    </view>
  </view>

  <!-- ç»“æœç»Ÿè®¡ -->
  <view class="result-summary" wx:if="{{isSearching}}">
    <text class="summary-text">æ‰¾åˆ° {{displayData.length}} æ¡ç›¸å…³ç»“æœ</text>
  </view>

  <!-- æ•°æ®åˆ—è¡¨ -->
  <view class="data-list">
    <view wx:if="{{displayData.length === 0}}" class="empty-state">
      <text class="empty-icon">ğŸ”</text>
      <text class="empty-text">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</text>
      <text class="empty-hint">è¯•è¯•å…¶ä»–å…³é”®è¯å§</text>
    </view>

    <view 
      wx:for="{{displayData}}" 
      wx:key="abbr" 
      class="data-item"
      bindtap="viewDetail"
      data-item="{{item}}"
    >
      <view class="item-header">
        <view class="abbr-wrapper">
          <text class="abbr-text">{{item.abbr}}</text>
          <text class="category-tag">{{item.category}}</text>
        </view>
        <view class="item-actions">
          <text 
            class="favorite-icon {{tools.isFavorited(favorites, item.abbr) ? 'favorited' : ''}}"
            catchtap="toggleFavorite"
            data-item="{{item}}"
          >
            {{tools.isFavorited(favorites, item.abbr) ? 'â˜…' : 'â˜†'}}
          </text>
        </view>
      </view>
      
      <view class="item-content">
        <view class="full-name">
          <text class="label">è‹±æ–‡ï¼š</text>
          <text class="value">{{item.full}}</text>
          <text 
            class="copy-btn"
            catchtap="copyFull"
            data-full="{{item.full}}"
          >ğŸ“‹</text>
        </view>
        
        <view class="chinese-name">
          <text class="label">ä¸­æ–‡ï¼š</text>
          <text class="value">{{item.chinese}}</text>
        </view>
        
        <!-- ç‰©ç†åŒ–å­¦ä¿¡æ¯ -->
        <view class="meta-info" wx:if="{{item.cas || item.formula || item.mw}}">
          <view class="meta-item" wx:if="{{item.cas}}">
            <text class="meta-label">CAS:</text>
            <text class="meta-value">{{item.cas}}</text>
            <text 
              class="copy-btn-small"
              catchtap="copyCAS"
              data-cas="{{item.cas}}"
            >ğŸ“‹</text>
          </view>
          <view class="meta-item" wx:if="{{item.formula}}">
            <text class="meta-label">å¼:</text>
            <text class="meta-value">{{item.formula}}</text>
          </view>
          <view class="meta-item" wx:if="{{item.mw}}">
            <text class="meta-label">MW:</text>
            <text class="meta-value">{{item.mw}}</text>
          </view>
        </view>
        
        <view class="description">
          <text class="desc-text">{{item.description}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤šæç¤º -->
  <view class="loading-more" wx:if="{{isLoading}}">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
  
  <view class="no-more" wx:if="{{!hasMore && displayData.length > 0}}">
    <text class="no-more-text">â€” å·²åŠ è½½å…¨éƒ¨ {{displayData.length}} æ¡æ•°æ® â€”</text>
  </view>

  <!-- åº•éƒ¨æç¤º -->
  <view class="footer-tips" wx:if="{{displayData.length > 0 && !isLoading}}">
    <text class="tips-text">ğŸ’¡ ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹è¯¦æƒ…ï¼Œç‚¹å‡»æ˜Ÿæ ‡æ”¶è—</text>
    <text class="tips-text">ğŸ“‹ ç‚¹å‡»å¤åˆ¶å›¾æ ‡å¯å¤åˆ¶å†…å®¹</text>
  </view>
</view>

