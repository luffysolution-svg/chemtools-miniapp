<view class="favorites-page">
  <!-- é¡¶éƒ¨æ ‡ç­¾åˆ‡æ¢ -->
  <view class="tab-bar">
    <view class="tab-item {{activeTab === 'favorites' ? 'active' : ''}}" bindtap="switchTab" data-tab="favorites">
      <text class="tab-icon">â­</text>
      <text class="tab-text">æ”¶è—</text>
    </view>
    <view class="tab-item {{activeTab === 'history' ? 'active' : ''}}" bindtap="switchTab" data-tab="history">
      <text class="tab-icon">ğŸ“</text>
      <text class="tab-text">å†å²è®°å½•</text>
    </view>
  </view>

  <!-- æ”¶è—å†…å®¹ -->
  <view wx:if="{{activeTab === 'favorites'}}" class="tab-content">
    <!-- æ·»åŠ æ”¶è—è¡¨å• -->
    <view class="add-form">
      <view class="form-title">æ·»åŠ æ”¶è—</view>
      
      <view class="form-field">
        <picker mode="selector" range="{{categories}}" value="{{categoryIndex}}" bindchange="handleCategoryChange">
          <view class="picker-display">
            <text class="picker-label">åˆ†ç±»</text>
            <text class="picker-value">{{categories[categoryIndex]}}</text>
          </view>
        </picker>
      </view>

      <view class="form-field">
        <input class="form-input" placeholder="æ ‡é¢˜" value="{{title}}" bindinput="handleTitleInput" />
      </view>

      <view class="form-field">
        <input class="form-input" placeholder="å¤‡æ³¨" value="{{note}}" bindinput="handleNoteInput" />
      </view>

      <view class="form-field">
        <textarea class="form-textarea" placeholder="æ­£æ–‡å†…å®¹" value="{{body}}" bindinput="handleBodyInput"></textarea>
      </view>

      <view class="form-actions">
        <button class="btn-primary" bindtap="addFavorite">{{editingId ? 'ä¿å­˜ä¿®æ”¹' : 'æ·»åŠ æ”¶è—'}}</button>
        <button class="btn-secondary" bindtap="clearForm">æ¸…ç©º</button>
      </view>
    </view>

    <!-- æ”¶è—åˆ—è¡¨ -->
    <view class="favorite-list">
      <!-- æ‰‹åŠ¨æ·»åŠ çš„æ”¶è— -->
      <view class="list-header">
        <text class="list-title">ğŸ’¬ ç¬”è®°æ”¶è— ({{favorites.length}})</text>
        <text class="clear-all" wx:if="{{favorites.length > 0}}" bindtap="clearAllFavorites">æ¸…ç©ºå…¨éƒ¨</text>
      </view>

      <view wx:if="{{favorites.length === 0}}" class="empty-state">
        <text class="empty-icon">ğŸ“Œ</text>
        <text class="empty-text">è¿˜æ²¡æœ‰ç¬”è®°æ”¶è—</text>
        <text class="empty-hint">å¯ä»¥ä¿å­˜å¸¸ç”¨çš„ææ–™ã€ååº”æˆ–ç¬”è®°</text>
      </view>

      <view wx:for="{{favorites}}" wx:key="id" class="favorite-item">
        <view class="item-header">
          <view class="item-category">{{categories[item.categoryIndex]}}</view>
          <view class="item-time">{{item.time}}</view>
        </view>
        <view class="item-title">{{item.title}}</view>
        <view class="item-note" wx:if="{{item.note}}">{{item.note}}</view>
        <view class="item-body" wx:if="{{item.body}}">{{item.body}}</view>
        <view class="item-actions">
          <button class="action-btn" bindtap="copyFavorite" data-text="{{item.copyText}}">
            <text class="btn-icon">ğŸ“‹</text> å¤åˆ¶
          </button>
          <button class="action-btn" bindtap="editFavorite" data-id="{{item.id}}">
            <text class="btn-icon">âœï¸</text> ç¼–è¾‘
          </button>
          <button class="action-btn danger" bindtap="deleteFavorite" data-id="{{item.id}}">
            <text class="btn-icon">ğŸ—‘ï¸</text> åˆ é™¤
          </button>
        </view>
      </view>
      
      <!-- æ”¶è—çš„è®¡ç®—å†å² -->
      <view class="list-header" style="margin-top: 30rpx;">
        <text class="list-title">â­ æ”¶è—çš„è®¡ç®— ({{favoritedCalculations.length}})</text>
      </view>

      <view wx:if="{{favoritedCalculations.length === 0}}" class="empty-state">
        <text class="empty-icon">â­</text>
        <text class="empty-text">è¿˜æ²¡æœ‰æ”¶è—çš„è®¡ç®—</text>
        <text class="empty-hint">åœ¨å†å²è®°å½•é¡µé¢ç‚¹å‡»â­å¯ä»¥æ”¶è—é‡è¦çš„è®¡ç®—</text>
      </view>

      <view wx:for="{{favoritedCalculations}}" wx:key="id" class="favorite-item calculation-item">
        <view class="item-header">
          <view class="item-category">{{item.title}}</view>
          <view class="item-time">{{item.timeStr}}</view>
        </view>
        <view class="history-content">
          <view class="history-input">è¾“å…¥ï¼š{{item.input}}</view>
          <view class="history-result">ç»“æœï¼š{{item.result}}</view>
          <view wx:if="{{item.userNote}}" class="user-note">
            <text class="note-icon">ğŸ“</text>
            <text class="note-text">{{item.userNote}}</text>
          </view>
          <view wx:if="{{item.warning}}" class="history-warning">
            <text class="warning-icon">âš ï¸</text>
            <text class="warning-text">{{item.warning}}</text>
          </view>
          <view wx:if="{{item.tags && item.tags.length > 0}}" class="tags">
            <text wx:for="{{item.tags}}" wx:key="*this" class="tag">{{item}}</text>
          </view>
        </view>
        <view class="item-actions">
          <button class="action-btn" bindtap="copyHistory" data-text="{{item.copyText}}">
            <text class="btn-icon">ğŸ“‹</text> å¤åˆ¶
          </button>
          <button class="action-btn danger" bindtap="toggleFavoriteHistory" data-id="{{item.id}}">
            <text class="btn-icon">ğŸ’”</text> å–æ¶ˆæ”¶è—
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- å†å²è®°å½•å†…å®¹ -->
  <view wx:if="{{activeTab === 'history'}}" class="tab-content">
    <!-- ç­›é€‰å™¨å¤´éƒ¨ -->
    <view class="filter-header">
      <view class="filter-title">
        <text class="title-text">å†å²è®°å½• ({{filteredHistory.length}}/{{totalHistory}})</text>
        <button class="filter-toggle-btn" bindtap="toggleFilterPanel">
          <text class="filter-icon">ğŸ”</text>
          <text>{{showFilterPanel ? 'æ”¶èµ·ç­›é€‰' : 'å±•å¼€ç­›é€‰'}}</text>
        </button>
      </view>
    </view>

    <!-- ç­›é€‰é¢æ¿ -->
    <view class="filter-panel {{showFilterPanel ? 'show' : 'hide'}}">
      <!-- å…³é”®è¯æœç´¢ -->
      <view class="filter-section">
        <view class="section-label">ğŸ” å…³é”®è¯æœç´¢</view>
        <view class="search-box">
          <input 
            class="search-input" 
            placeholder="æœç´¢è¾“å…¥æˆ–ç»“æœ..." 
            value="{{searchKeyword}}"
            bindinput="handleSearchInput"
            confirm-type="search"
            bindconfirm="applyFilter"
          />
          <text wx:if="{{searchKeyword}}" class="clear-search-btn" bindtap="clearSearch">Ã—</text>
        </view>
      </view>

      <!-- ç±»åˆ«ç­›é€‰ -->
      <view class="filter-section">
        <view class="section-label">ğŸ“ è®¡ç®—ç±»åˆ«</view>
        <view class="filter-options">
          <view 
            wx:for="{{categoryFilters}}" 
            wx:key="id"
            class="filter-option {{categoryFilterIndex === index ? 'active' : ''}}"
            data-index="{{index}}"
            bindtap="handleCategoryFilterChange"
          >
            {{item}}
          </view>
        </view>
      </view>

      <!-- æ—¶é—´èŒƒå›´ç­›é€‰ -->
      <view class="filter-section">
        <view class="section-label">ğŸ“… æ—¶é—´èŒƒå›´</view>
        <view class="filter-options">
          <view 
            wx:for="{{dateFilters}}" 
            wx:key="id"
            class="filter-option {{dateFilterIndex === index ? 'active' : ''}}"
            data-index="{{index}}"
            bindtap="handleDateFilterChange"
          >
            {{item}}
          </view>
        </view>
      </view>

      <!-- è­¦å‘Šç­›é€‰ -->
      <view class="filter-section">
        <view class="section-label">âš ï¸ è­¦å‘Šè®°å½•</view>
        <view class="filter-switch">
          <switch 
            checked="{{showWarningOnly}}" 
            bindchange="handleWarningFilterChange"
            color="#4CAF50"
          />
          <text class="switch-label">ä»…æ˜¾ç¤ºåŒ…å«è­¦å‘Šçš„è®°å½•</text>
        </view>
      </view>

      <!-- ç­›é€‰æŒ‰é’® -->
      <view class="filter-actions">
        <button class="btn-filter-apply" bindtap="applyFilter">åº”ç”¨ç­›é€‰</button>
        <button class="btn-filter-reset" bindtap="resetFilter">é‡ç½®</button>
      </view>
    </view>

    <!-- å¿«é€Ÿç­›é€‰æ ï¼ˆæ—§ç‰ˆï¼Œä¿ç•™ä»¥å…¼å®¹ï¼‰ -->
    <view class="quick-filter-bar">
      <picker mode="selector" range="{{typeFilters}}" value="{{typeFilterIndex}}" bindchange="handleTypeFilterChange">
        <view class="filter-picker">
          <text>{{typeFilters[typeFilterIndex]}}</text>
          <text class="picker-arrow">â–¼</text>
        </view>
      </picker>
      <button class="clear-btn" bindtap="clearHistory">æ¸…ç©ºå†å²</button>
    </view>

    <!-- éª¨æ¶å± -->
    <skeleton wx:if="{{historyLoading}}" type="list" rows="8"></skeleton>

    <!-- å†å²åˆ—è¡¨ -->
    <view wx:else class="history-list">
      <view wx:if="{{filteredHistory.length === 0 && totalHistory === 0}}" class="empty-state">
        <text class="empty-icon">ğŸ“</text>
        <text class="empty-text">æš‚æ— å†å²è®°å½•</text>
        <text class="empty-hint">æ‚¨çš„è®¡ç®—å†å²å°†åœ¨è¿™é‡Œæ˜¾ç¤º</text>
      </view>

      <view wx:if="{{filteredHistory.length === 0 && totalHistory > 0}}" class="empty-state">
        <text class="empty-icon">ğŸ”</text>
        <text class="empty-text">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•</text>
        <text class="empty-hint">è¯•è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶</text>
      </view>

      <view wx:for="{{filteredHistory}}" wx:key="id" class="history-item {{item.hasWarning ? 'has-warning' : ''}} {{item.isFavorited ? 'is-favorited' : ''}}">
        <view class="history-header">
          <view class="history-type">
            {{item.title}}
            <text wx:if="{{item.isFavorited}}" class="favorited-badge">â­</text>
          </view>
          <view class="history-time">{{item.timeStr}}</view>
        </view>
        <view class="history-content">
          <view class="history-input">è¾“å…¥ï¼š{{item.input}}</view>
          <view class="history-result">ç»“æœï¼š{{item.result}}</view>
          <view wx:if="{{item.warning}}" class="history-warning">
            <text class="warning-icon">âš ï¸</text>
            <text class="warning-text">{{item.warning}}</text>
          </view>
        </view>
        <view class="history-actions">
          <button class="action-btn-small {{item.isFavorited ? 'favorited' : ''}}" bindtap="toggleFavoriteHistory" data-id="{{item.id}}">
            <text class="btn-icon">{{item.isFavorited ? 'â­' : 'â˜†'}}</text> {{item.isFavorited ? 'å·²æ”¶è—' : 'æ”¶è—'}}
          </button>
          <button class="action-btn-small" bindtap="copyHistory" data-text="{{item.copyText}}">
            <text class="btn-icon">ğŸ“‹</text> å¤åˆ¶
          </button>
          <button class="action-btn-small" bindtap="deleteHistory" data-id="{{item.id}}">
            <text class="btn-icon">ğŸ—‘ï¸</text> åˆ é™¤
          </button>
        </view>
      </view>
    </view>

    <!-- å¯¼å‡ºæŒ‰é’® -->
    <view class="export-actions" wx:if="{{filteredHistory.length > 0}}">
      <button class="export-btn" bindtap="exportHistory">
        <text class="btn-icon">ğŸ“¤</text> å¯¼å‡ºç­›é€‰ç»“æœ ({{filteredHistory.length}}æ¡)
      </button>
    </view>
  </view>
</view>

