# 项目开发指南

**版本**: v3.2.0  
**最后更新**: 2025-10-11

---

## 📖 目录

1. [项目结构](#项目结构)
2. [开发规范](#开发规范)
3. [组件开发](#组件开发)
4. [工具函数开发](#工具函数开发)
5. [页面开发](#页面开发)
6. [服务层开发](#服务层开发)
7. [样式规范](#样式规范)
8. [测试规范](#测试规范)
9. [代码提交规范](#代码提交规范)
10. [最佳实践](#最佳实践)

---

## 项目结构

```
chemtools-miniapp/
├── app.js                    # 小程序入口
├── app.json                  # 全局配置
├── app.wxss                  # 全局样式
├── project.config.json       # 项目配置
├── README.md                 # 项目说明
├── LICENSE                   # 开源协议
├──docs/                     # 文档目录
│   ├── 项目文档索引.md
│   ├── 项目开发指南.md
│   ├── 待实现功能清单.md
│   ├── 组件使用文档.md
│   ├── 工具函数API文档.md
│   └── 服务层文档.md
├── components/               # 组件目录
│   ├── calculator-input/     # 计算器输入组件
│   ├── result-card/          # 结果卡片组件
│   ├── skeleton/             # 骨架屏组件
│   └── tool-card/            # 工具卡片组件
├── pages/                    # 页面目录
│   ├── home/                 # 首页
│   ├── favorites/            # 收藏页
│   ├── help/                 # 帮助页
│   ├── basic/                # 基础计算页面（分包）
│   │   ├── unit/             # 单位转换
│   │   ├── ph/               # pH计算
│   │   ├── solution/         # 溶液配制
│   │   └── molar/            # 摩尔计算
│   ├── advanced/             # 高级计算页面（分包）
│   │   ├── xrd/              # XRD计算
│   │   ├── electrochem/      # 电化学计算
│   │   ├── ksp/              # 溶度积计算
│   │   └── complexation/     # 络合计算
│   ├── materials/            # 材料数据库（分包）
│   │   ├── periodic/         # 元素周期表
│   │   ├── semiconductor/    # 半导体材料
│   │   └── semiconductor-extras/ # 半导体扩展
│   └── spectroscopy/         # 光谱工具（分包）
│       ├── xps-raman/        # XPS/Raman
│       └── uvvis/            # UV-Vis
├── services/                 # 服务层
│   ├── storage.js            # 存储服务
│   ├── history.js            # 历史记录服务
│   ├── export.js             # 导出服务
│   └── errorHandler.js       # 错误处理服务
└── utils/                    # 工具函数
    ├── conversions.js        # 单位转换
    ├── xrd.js                # XRD计算
    ├── electrochem.js        # 电化学计算
    ├── ksp.js                # 溶度积计算
    ├── semiconductors.js     # 半导体数据
    ├── periodic.js           # 元素周期表
    ├── complexation.js       # 络合计算
    ├── buffer.js             # 缓冲溶液
    ├── concentration.js      # 浓度计算
    ├── spectroscopy.js       # 光谱数据
    ├── uvvis.js              # UV-Vis计算
    └── semiconductor_extras.js # 半导体扩展
```

---

## 开发规范

### 1. 命名规范

#### 文件命名
- 页面文件: 小写字母，短横线分隔（如 `xrd.js`, `semiconductor-extras.js`）
- 组件文件: 小写字母，短横线分隔（如 `result-card.js`）
- 工具文件: 小写字母，驼峰命名（如 `conversions.js`, `errorHandler.js`）

#### 变量命名
```javascript
// 常量: 全大写，下划线分隔
const MAX_HISTORY_COUNT = 20;
const API_BASE_URL = 'https://api.example.com';

// 变量: 驼峰命名
let userName = 'John';
let isLoading = false;

// 函数: 驼峰命名，动词开头
function calculateDSpacing(theta, lambda) { }
function getUserData() { }
function setLoading(isLoading) { }

// 私有方法: 下划线开头
function _internalHelper() { }
```

#### 组件属性命名
```javascript
// 组件 properties
properties: {
  // 布尔值: is/has/can 开头
  isLoading: Boolean,
  hasError: Boolean,
  canEdit: Boolean,
  
  // 事件: on 开头
  onSuccess: Function,
  onError: Function,
  
  // 数据: 名词
  title: String,
  dataList: Array,
  config: Object
}
```

---

### 2. 代码风格

#### 缩进和空格
```javascript
// 使用 2 空格缩进
function example() {
  if (condition) {
    doSomething();
  }
}

// 运算符两边加空格
let sum = a + b;
let result = x * y;

// 逗号后加空格
let arr = [1, 2, 3];
let obj = { a: 1, b: 2 };
```

#### 大括号
```javascript
// 左大括号不换行
if (condition) {
  doSomething();
} else {
  doOtherThing();
}

// 单行语句也使用大括号
if (condition) {
  return true;
}
```

#### 注释规范
```javascript
/**
 * 函数说明（多行注释）
 * @param {number} theta - 2θ角度
 * @param {number} lambda - 波长
 * @returns {object} 计算结果或错误对象
 */
function calculateDSpacing(theta, lambda) {
  // 单行注释：输入验证
  if (!isValid(theta)) {
    return { error: '角度无效' };
  }
  
  // 计算 d 值
  const d = lambda / (2 * Math.sin(theta * Math.PI / 180));
  
  return { d, unit: 'Å' };
}
```

---

### 3. 错误处理

#### 统一的错误返回格式
```javascript
// 成功返回
{
  value: 2.456,
  unit: 'Å',
  precision: '±0.001 Å',
  formula: 'd = λ/(2sinθ)',
  conditions: ['λ = 1.5406 Å', '2θ = 36.5°']
}

// 错误返回
{
  error: '输入角度超出范围',
  errorCode: 'RANGE_ERROR',
  details: {
    parameter: 'theta',
    value: 200,
    range: '0° < 2θ < 180°'
  }
}
```

#### 使用 try-catch
```javascript
try {
  const result = calculateSomething(input);
  if (result.error) {
    throw new Error(result.error);
  }
  return result;
} catch (error) {
  errorHandler.logError(error, 'calculateSomething');
  return { error: error.message };
}
```

---

## 组件开发

### 组件结构

```javascript
// component.js
Component({
  options: {
    styleIsolation: 'shared',  // 样式隔离
    multipleSlots: true         // 多插槽支持
  },
  
  properties: {
    // 属性定义
    title: {
      type: String,
      value: '默认标题'
    }
  },
  
  data: {
    // 内部数据
    count: 0
  },
  
  lifetimes: {
    // 生命周期
    attached() {
      // 组件挂载
    },
    detached() {
      // 组件卸载
    }
  },
  
  methods: {
    // 方法
    handleClick() {
      this.triggerEvent('click', { data: 'value' });
    }
  }
});
```

### 组件通信

```javascript
// 父组件调用子组件
<custom-component 
  title="标题" 
  bind:success="onSuccess"
/>

// 子组件触发事件
this.triggerEvent('success', { 
  message: '操作成功' 
});

// 父组件接收
onSuccess(e) {
  console.log(e.detail.message);
}
```

---

## 工具函数开发

### 标准模板

```javascript
/**
 * 工具函数模块说明
 * 数据来源：XXXX
 */

// 元数据
const METADATA = {
  version: '1.0.0',
  lastUpdated: '2025-10-10',
  sources: {
    data: '数据来源',
    formula: '公式来源',
    citation: '引用'
  },
  precision: {
    param1: '精度说明'
  },
  applicableRange: {
    param1: '适用范围'
  }
};

/**
 * 获取元数据
 * @returns {object} 元数据对象
 */
function getMetadata() {
  return METADATA;
}

/**
 * 主要计算函数
 * @param {number} input1 - 参数说明
 * @param {number} input2 - 参数说明
 * @returns {object} 计算结果或错误对象
 */
function calculate(input1, input2) {
  // 1. 输入验证
  if (!Number.isFinite(input1)) {
    return {
      error: '参数1必须是有效数字',
      errorCode: 'INVALID_INPUT',
      details: { parameter: 'input1', value: input1 }
    };
  }
  
  // 2. 范围检查
  if (input1 < 0 || input1 > 100) {
    return {
      error: '参数1超出适用范围',
      errorCode: 'RANGE_ERROR',
      details: { 
        parameter: 'input1', 
        value: input1, 
        range: '0 < input1 < 100' 
      }
    };
  }
  
  // 3. 执行计算
  const result = input1 * input2;
  
  // 4. 构建返回值
  const output = {
    result,
    unit: '单位',
    precision: '精度说明',
    formula: '计算公式',
    conditions: ['条件1', '条件2']
  };
  
  // 5. 添加警告（如果需要）
  if (input1 > 80) {
    output.warning = '参数接近上限，结果可能不准确';
  }
  
  return output;
}

// 导出
module.exports = {
  getMetadata,
  calculate
};
```

---

## 页面开发

### 页面结构

```javascript
// page.js
const util = require('../../utils/someUtil');
const { historyService } = require('../../services/history');
const { exportService } = require('../../services/export');

Page({
  data: {
    // 输入数据
    input1: '',
    input2: '',
    
    // 结果数据
    resultType: 'default',  // default/success/warning/error
    resultText: '',
    unit: '',
    precision: '',
    formula: '',
    conditions: [],
    warning: '',
    dataSource: '',
    
    // UI状态
    loading: false,
    showModal: false
  },
  
  onLoad(options) {
    // 页面加载
  },
  
  onShow() {
    // 页面显示
  },
  
  // 输入处理
  handleInput1(e) {
    this.setData({ input1: e.detail.value });
  },
  
  // 计算
  calculate() {
    // 1. 验证输入
    if (!this.validateInput()) {
      return;
    }
    
    // 2. 显示加载
    this.setData({ loading: true });
    
    // 3. 执行计算
    const result = util.calculate(
      parseFloat(this.data.input1),
      parseFloat(this.data.input2)
    );
    
    // 4. 处理结果
    if (result.error) {
      this.setData({
        loading: false,
        resultType: 'error',
        resultText: result.error,
        warning: result.error
      });
    } else {
      this.setData({
        loading: false,
        resultType: 'success',
        resultText: `结果 = ${result.result} ${result.unit}`,
        unit: result.unit,
        precision: result.precision,
        formula: result.formula,
        conditions: result.conditions,
        warning: result.warning || '',
        dataSource: '数据来源说明'
      });
    }
  },
  
  // 输入验证
  validateInput() {
    if (!this.data.input1 || !this.data.input2) {
      wx.showToast({
        title: '请填写所有参数',
        icon: 'none'
      });
      return false;
    }
    return true;
  },
  
  // 分享
  onShareAppMessage() {
    return {
      title: '页面标题',
      path: '/pages/xxx/xxx'
    };
  }
});
```

---

## 服务层开发

### 服务模板

```javascript
/**
 * 服务说明
 */
class SomeService {
  constructor() {
    this.cache = {};
  }
  
  /**
   * 方法说明
   * @param {any} param - 参数说明
   * @returns {any} 返回值说明
   */
  someMethod(param) {
    // 实现
  }
}

// 导出单例
const someService = new SomeService();
module.exports = { someService };
```

---

## 样式规范

### 1. 命名规范

```css
/* BEM 命名法 */
.block { }                    /* 块 */
.block__element { }           /* 元素 */
.block--modifier { }          /* 修饰符 */
.block__element--modifier { } /* 元素修饰符 */

/* 示例 */
.result-card { }              /* 结果卡片 */
.result-card__header { }      /* 卡片头部 */
.result-card--success { }     /* 成功状态 */
.result-card__header--large { } /* 大号头部 */
```

### 2. 单位使用

```css
/* 使用 rpx 作为主要单位 */
.element {
  width: 750rpx;    /* 屏幕宽度 */
  padding: 30rpx;   /* 间距 */
  font-size: 28rpx; /* 字体 */
}

/* 边框使用 rpx */
.border {
  border: 2rpx solid #e0e0e0;
}

/* 特殊情况使用 px */
.hairline {
  border: 1px solid #e0e0e0;  /* 1物理像素 */
}
```

### 3. 颜色规范

```css
/* 主色 */
--primary-color: #1f3c88;
--secondary-color: #667eea;

/* 功能色 */
--success-color: #0ea5e9;
--warning-color: #f59e0b;
--error-color: #dc3545;
--info-color: #6c757d;

/* 文本色 */
--text-primary: #2d3142;
--text-secondary: #666;
--text-tertiary: #999;

/* 背景色 */
--bg-primary: #ffffff;
--bg-secondary: #f8f9fa;
--bg-tertiary: #f0f2f5;
```

### 4. 动画规范

```css
/* 标准过渡 */
.transition-standard {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 快速反馈 */
.transition-fast {
  transition: all 0.2s ease;
}

/* 平滑动画 */
@keyframes smooth-animation {
  from { opacity: 0; }
  to { opacity: 1; }
}

.smooth {
  animation: smooth-animation 0.3s ease-out;
}
```

---

## 测试规范

### 1. 功能测试

```javascript
// 测试用例示例
describe('XRD计算', () => {
  it('应该正确计算d值', () => {
    const result = xrd.dFromTheta2(36.5, 1.5406);
    expect(result.d).toBeCloseTo(2.456, 3);
  });
  
  it('应该检测无效输入', () => {
    const result = xrd.dFromTheta2(-10, 1.5406);
    expect(result.error).toBeDefined();
  });
});
```

### 2. 测试清单

每个新功能开发后需要测试：
- ✅ 正常流程测试
- ✅ 边界值测试
- ✅ 错误输入测试
- ✅ 性能测试（如果涉及大数据）
- ✅ 真机测试（iOS + Android）

---

## 代码提交规范

### Commit Message 格式

```
type(scope): subject

body

footer
```

### Type 类型

- `feat`: 新功能
- `fix`: Bug修复
- `docs`: 文档更新
- `style`: 代码格式（不影响功能）
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建/工具相关

### 示例

```
feat(xrd): 添加XRD计算元数据支持

- 添加完整的输入验证
- 返回详细的元数据
- 支持多种射线源

Closes #123
```

---

## 最佳实践

### 1. 性能优化

```javascript
// ✅ 使用 setData 批量更新
this.setData({
  loading: false,
  result: data,
  showModal: true
});

// ❌ 避免多次 setData
this.setData({ loading: false });
this.setData({ result: data });
this.setData({ showModal: true });

// ✅ 避免在 onShow 中频繁操作
onShow() {
  if (!this.data.initialized) {
    this.loadData();
    this.setData({ initialized: true });
  }
}
```

### 2. 内存管理

```javascript
// ✅ 页面卸载时清理数据
onUnload() {
  this.setData({
    largeDataArray: null,
    imageUrls: []
  });
}

// ✅ 避免内存泄漏
let timer = null;
onLoad() {
  timer = setInterval(() => {}, 1000);
}
onUnload() {
  clearInterval(timer);
}
```

### 3. 用户体验

```javascript
// ✅ 添加加载提示
wx.showLoading({ title: '计算中...' });
try {
  await calculate();
} finally {
  wx.hideLoading();
}

// ✅ 友好的错误提示
wx.showToast({
  title: '参数格式错误',
  icon: 'none',
  duration: 2000
});

// ✅ 防止重复点击
data: { calculating: false },
async calculate() {
  if (this.data.calculating) return;
  this.setData({ calculating: true });
  try {
    await doCalculation();
  } finally {
    this.setData({ calculating: false });
  }
}
```

---

## 开发流程

### 1. 开发新功能

1. 查看 [待实现功能清单](./待实现功能清单.md)
2. 创建功能分支: `git checkout -b feature/xxx`
3. 开发并测试
4. 提交代码: `git commit -m "feat: xxx"`
5. 合并到主分支

### 2. 修复Bug

1. 创建修复分支: `git checkout -b fix/xxx`
2. 修复并测试
3. 提交代码: `git commit -m "fix: xxx"`
4. 合并到主分支

### 3. 发布版本

1. 更新版本号
2. 更新文档
3. 创建发布标签: `git tag v2.1.0`
4. 推送标签: `git push --tags`

---

**维护者**: 项目开发团队  
**最后更新**: 2025-10-10

